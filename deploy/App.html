<!DOCTYPE html>
<html>
<head>
    <title>StoryMap</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Rally.ui.cardboard.row.HeaderFix",{override:"Rally.ui.cardboard.row.Header",_getTitle:function(){var value=this.getValue();return null!=value?value.Project.Name+" - "+value.Name:"-- Not Scheduled --"}}),Ext.define("StoryMap",{extend:"Rally.app.App",componentCls:"app",launch:function(){app=this;var filterState=app.getSetting("PIStateFilter"),PIFilter=Ext.create("Ext.util.Filter",{});"-- No Entry --"!=filterState&""!=filterState&&(PIFilter=Ext.create("Ext.util.Filter",{property:"State",value:filterState})),Ext.create("Rally.data.wsapi.Store",{model:"PortfolioItem/"+app.getSetting("PITypeField"),fetch:["Name","ObjectID","Project","FormattedID"],limit:1/0,filters:PIFilter,sorters:[{property:"FormattedID",direction:"ASC"}],autoLoad:!0,listeners:{load:function(myStore,myData,mySuccess){var columns=[{record:null,value:null,columnHeaderConfig:{headerData:{PIhdr:"No Parent"}}}];_.each(myData,function(record){columns.push({tpl:Ext.create("Rally.ui.renderer.template.FormattedIDTemplate"),record:record,value:record.getRef().getRelativeUri(),columnHeaderConfig:{headerData:{PIhdr:record.get("FormattedID")+" - "+record.get("_refObjectName")}}})}),app._addNewButton(),app._addBoard(columns)},scope:this}})},_addNewButton:function(){app.addButton&&app.addButton.destroy(),addNewConfig={xtype:"rallyaddnew",recordTypes:["User Story"],ignoredRequiredFields:["Name","ScheduleState","Project","Owner"],listeners:{create:function(addNew,record){}},showAddWithDetails:!0},app.addButton=this.add(addNewConfig)},_addBoard:function(columns){this.down("#myBoard")&&this.remove("myBoard"),boardConfig={xtype:"rallycardboard",types:["User Story"],storeConfig:{filters:app.getQueryFilter()},attribute:app.getSetting("PITypeField"),itemId:"myBoard",context:this.getContext(),enableRanking:!0,cardConfig:{fields:["Name","PlanEstimate","Owner"],editable:!0,showIconsAndHighlightBorder:!0,showReadyIcon:!0,showBlockedIcon:!0,showColorIcon:!0,showPlusIcon:!0,showGearIcon:!0},columnConfig:{columnHeaderConfig:{headerTpl:"{PIhdr}"},listeners:{scope:this,beforecarddroppedsave:function(column,card){var rec=card.getRecord();rec.set("PortfolioItem",column.getValue())}}},columns:columns,rowConfig:{field:app.getSetting("RowType"),enableCrossRowDragging:!0,sortDirection:"ASC"}},console.log(boardConfig),app.board=this.add(boardConfig)},_addRowButton:function(){app.rowButton&&app.rowButton.destroy(),addNewRowConfig={html:'<div><input type="button" style="text-align:right;float:right;" value="Update" onClick="window.location.reload()"/></div>',xtype:"rallyaddnew",newButtonText:"+ New Row",recordTypes:[app.getSetting("RowType")],listeners:{create:function(addNew,record){app.launch()}},showAddWithDetails:!0},app.rowButton=app.add(addNewRowConfig)},getSettingsFields:function(){var values=[{xtype:"label",forId:"myFieldId1",text:"PI Filter",margin:"0 0 0 10"},{name:"PIStateFilterPicker",xtype:"rallyfieldvaluecombobox",model:"PortfolioItem/"+app.getSetting("PITypeField"),field:"State",boxLabelAlign:"after",fieldLabel:"State",margin:"0 0 15 50",labelStyle:"width:200px;",afterLabelTpl:"Click on State to filter Features in columns",handlesEvents:{myspecialevent1:function(field,model){this.setField(field.raw.fieldDefinition)}},listeners:{select:function(state_picker,records){this.fireEvent("state_selected",_.first(records).get("name"))}},bubbleEvents:["state_selected"]},{name:"PIStateFilter",width:200,xtype:"rallytextfield",boxLabelAlign:"after",fieldLabel:"Filter State",readOnly:!0,margin:"0 0 15 50",labelStyle:"width:200px;",handlesEvents:{state_selected:function(state){this.setValue(state)}}},{xtype:"label",forId:"myFieldId2",text:"PI Type",margin:"0 0 0 10"},{name:"PITypeField",xtype:"rallytextfield",margin:"0 0 15 50",label:"Portfolio Item Column Type (MUST be lowest level PI that can parent stories)",labelWidth:200},{xtype:"label",forId:"myFieldId3",text:"Row Type (Iteration/Release)",margin:"0 0 0 10"},{xtype:"rallyradiofield",fieldLabel:"Iteration",margin:"0 0 15 50",name:"RowType",label:"Swimlane",inputValue:"Iteration"},{xtype:"rallyradiofield",margin:"0 0 15 50",fieldLabel:"Release",name:"RowType",inputValue:"Release"},{type:"query"}];return values},config:{defaultSettings:{PIStateFilter:"-- No Entry --",PITypeField:"Feature",RowType:"Iteration"}},getQueryFilter:function(){var queries=[];return app.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(app.getSetting("query"))),queries}});

            Rally.launchApp('StoryMap', {
                name:"StoryMap",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
